# 🎮 Smart You — игра, где ты учишься писать смарт‑контракты

> Smart You — учебная игра по Solidity. Пишешь код — запускаешь мини‑игру — проходишь 5 миссий — копишь XP и достижения — получаешь сертификат «Страж Блокчейна». Подходит для школьников и студентов.

## 🎯 Особенности игры

- **5 уровней обучения**: От базового синтаксиса до продвинутой безопасности
- **Интерактивный редактор** Solidity с подсветкой синтаксиса  
- **Анимированные персонажи** и визуальная симуляция выполнения контракта
- **AI-помощник от Remix** для подсказок и проверки кода
- **Система наград**: XP, достижения, бейджи, сертификаты
- **Геймплей**: код → симуляция → результат

## 🏗️ Что под капотом (коротко)

- **Next.js + TypeScript** — сайт и серверные маршруты
- **PostgreSQL (Prisma)** — хранение прогресса, кода уровней, достижений
- **Redis** — кэш для быстроты
- **BullMQ** — фоновый пересчёт таблицы лидеров
- **SWR** — быстрые клиентские запросы

---

### Структура проекта (расширенно)
- `src/app/`
  - `page.tsx` — главный экран: редактор кода, мини‑игра, консоль, модалки
  - `layout.tsx` — общий каркас, авто‑посев достижений через `/api/seed`
  - `api/`
    - `users/route.ts` — имя/кошелёк
    - `progress/route.ts` — прогресс (GET — отдаёт, POST — сохраняет и инвалидация кэша)
    - `level-code/route.ts` — код уровня (GET/POST с кэшем, инвалидация)
    - `compile/route.ts` — проверка Solidity (валидатор + rate limit)
    - `leaderboard/route.ts` — отдаёт кэшированный лидерборд; проставляет текущего игрока
    - `leaderboard/rebuild/route.ts` — складывает задачи пересборки в очередь
    - `levels/complete/route.ts` — фиксирует пройденный уровень, выдает достижения и XP
    - `seed-achievements/route.ts`, `seed/route.ts` — разовая загрузка списка достижений
- `src/components/`
  - `GameHeader.tsx` — верхняя панель: «Remix», «Достижения», «Лидеры», «Сертификат», «MetaMask»
  - `CodeEditor.tsx` — редактор с кнопками «Сброс», «Сохранить», «Примеры», «Компилировать и запустить», индикатор статуса и автосохранения
  - `FlexboxDefenseGame.tsx` — мини‑игра (ленивая загрузка)
  - Модалки: `AchievementsModal.tsx`, `LeaderboardModal.tsx`, `CertificateModal.tsx`, `RemixInfo.tsx`, `UsernameModal.tsx`
  - Прочие: `Console.tsx`, `LevelInfo.tsx`, `AIAssistant.tsx` и т.д.
- `src/lib/`
  - `prisma.ts` — подключение к БД
  - `redis.ts` — подключение к Redis (настроено под BullMQ)
  - `hooks.ts` — SWR‑хуки `useProgress`, `useLeaderboard`
  - `queue.ts` — очередь для фоновых задач лидерборда
  - `gameStorage.ts` — вспомогательные методы прогресса (теперь данные приходят из БД)
- `src/workers/leaderboardWorker.ts` — обработчик задач: читает данные из БД, строит лидерборд, кладёт в Redis
- `prisma/schema.prisma` — схема БД с индексами
- `Dockerfile`, `docker-compose.yml` — инфраструктура запуска

---

### Стек технологий и где именно он используется
- Frontend
  - Next.js 14 (App Router)
    - Страницы: `src/app/page.tsx`, каркас `src/app/layout.tsx`
    - Серверные роуты (API): `src/app/api/**/route.ts`
  - TypeScript — типобезопасность во всём приложении
  - Tailwind CSS — стили интерфейса (быстро и единообразно)
  - SWR — клиентский кэш и простые запросы к API
    - Хуки: `src/lib/hooks.ts` (`useLeaderboard`, `useProgress`)
  - CodeMirror — редактор кода Solidity
    - Компонент: `src/components/CodeMirrorEditor.tsx`
    - Включён лениво (dynamic import) в `src/components/CodeEditor.tsx`
  - Ленивая загрузка тяжёлых компонентов (Next dynamic import)
    - Игра `FlexboxDefenseGame` — подгружается на лету
    - Модалки: `AchievementsModal`, `LeaderboardModal`, `RemixInfo` — подгружаются при открытии
  - next/image — оптимизированные картинки (например, иконка в `RemixInfo`)

- Backend и хранение данных
  - PostgreSQL + Prisma — вся логика прогресса и кода уровней хранится в БД
    - Модели: `User`, `Progress`, `CompletedLevel`, `UnlockedLevel`, `UserAchievement`, `AchievementDefinition`, `LevelCode`
    - Схема: `prisma/schema.prisma` (добавлены индексы на `currentLevel` и композитные индексы по `userId/levelId`)
  - Redis (ioredis) — кэш для быстрого ответа
    - Кэшируются: прогресс (`progress:<name>`), код уровня (`levelcode:<name>:<level>`), лидерборд (`leaderboard:<category>`)
  - BullMQ worker — фоновые задачи
    - Воркер: `src/workers/leaderboardWorker.ts` пересчитывает таблицу лидеров и пишет результат в Redis
    - Очередь: `src/lib/queue.ts` + API `/api/leaderboard/rebuild`
  - Zod — валидация входных данных в API
    - Пример: `/api/compile` (валидирует `code`, `runs`, `optimize`)
  - Защита от частых запросов (rate limit) — `/api/compile`
    - Лимит: 10 запросов в минуту на IP

- Docker
  - Многостадийный `Dockerfile` (Next.js standalone + сборка воркера в `dist`)
  - `docker-compose.yml`: сервисы `db` (Postgres), `redis`, `web`, `worker`


## 🚀 Быстрый старт (без Docker)

### Установка зависимостей

```bash
# Установить Node.js зависимости
npm install
```

### Запуск в режиме разработки

```bash
npm run dev
```

Приложение будет доступно по адресу [http://localhost:3000](http://localhost:3000)

### Уровни

1. **Кошелек в опасности** - Основы смарт-контрактов
2. **Электронное голосование** - Mapping и контроль доступа  
3. **Рынок магии** - Struct и взаимодействие
4. **DAO - Совет защитников** - Децентрализованное управление
5. **Испытание хакера** - Безопасность и уязвимости

### Схема интерфейса (обновлённая)
```
┌─────────────────────────────────────────────────────────────┐
│                        Header (Smart You)                    │
│  [Remix] [Достижения] [Лидеры] [Сертификат] [MetaMask]      │
├──────────────────────┬──────────────────────────────────────┤
│                      │                                      │
│    Редактор кода     │         Игровая область              │
│      (CodeMirror)    │      (анимация, прохождение)         │
│                      │                                      │
│                      ├──────────────────────────────────────┤
│                      │                                      │
│                      │              Консоль                 │
│                      │           (логи и ошибки)            │
└──────────────────────┴──────────────────────────────────────┘
```

- В редакторе: кнопки «Сброс», «Сохранить», «Примеры», «Автозапуск», «Компилировать и запустить», статус компиляции, индикатор «Автосохранено».
- В шапке: модалки «Достижения» и «Лидеры» открываются по кнопке, «Сертификат» активен после 5/5, «MetaMask» показывает адрес после подключения.

### Игровые механики (что есть сейчас)
- Миссии (5 уровней) — после каждой успешной проверки кода запускается мини‑игра.
- XP и уровни игрока — накапливаются за прохождение миссий и достижения.
- Достижения — выдаются автоматически при выполнении условий (например, пройти 1 уровень, 5 уровней и т.д.).
- Таблица лидеров — соревновательная часть, сортировки по XP/скорости/достижениям/строкам кода.
- Сертификат — доступен при `completedLevels >= 5`, открывается модалка «Сертификат», можно распечатать.

## 📦 Папки проекта (коротко)

```
src/
├─ app/              # страницы и серверные роуты
├─ components/       # визуальные блоки (редактор, игра, модалки)
├─ lib/              # база, кэш, хуки, очередь
├─ workers/          # фоновые задачи (лидерборд)
└─ prisma/           # база (схема)
```

---

## 🎯 Простое ТЗ (как пользоваться)
1. При первом входе введи имя. Можно привязать MetaMask.
2. Пиши Solidity‑код, жми «Проверить и запустить».
3. Если всё ок — игра запускается, проходи миссию и получай опыт.
4. Смотри себя в «Лидерах». После 5 миссий — «Сертификат».

---

## 🐳 Запуск через Docker (самый простой способ)
Требуется Docker Desktop.

1) Создай `.env` в корне:
```bash
DATABASE_URL="postgresql://postgres:postgres@db:5432/syblock?schema=public"
REDIS_URL="redis://redis:6379"
```

2) Запусти всё:
```bash
docker compose up -d
```

3) Открой сайт:
- http://localhost:3000

Если 3000 занят — поменяй в `docker-compose.yml` на `3001:3000`, снова `docker compose up -d`.

Поднимаются:
- `db` — PostgreSQL
- `redis` — кэш
- `web` — сайт
- `worker` — фоновые лидеры

Пересчитать лидеров вручную (опционально):
```bash
curl -X POST http://localhost:3000/api/leaderboard/rebuild
```

---

## 🙌 Для кого и зачем
Для начинающих. Чтобы без скуки и сложных слов почувствовать себя разработчиком смарт‑контрактов. Тут безопасно пробовать, ошибаться и учиться.

Удачи и приятной игры! 🚀